/**
 * PDF Generator for Learning Roadmap
 * 
 * This file handles generating a downloadable PDF of the roadmap.
 */

document.addEventListener('DOMContentLoaded', function() {
    // Initialize PDF download if we're on the roadmap view page
    const roadmapData = document.getElementById('roadmapContent');
    if (roadmapData) {
        initPdfDownload();
    }
});

function initPdfDownload() {
    const downloadBtn = document.getElementById('downloadPdfBtn');
    
    if (downloadBtn) {
        downloadBtn.addEventListener('click', function() {
            const roadmapTitle = document.getElementById('roadmapTitle').textContent;
            generatePDF(roadmapTitle);
        });
    }
}

function generatePDF(roadmapTitle) {
    const loadingSpinner = document.createElement('span');
    loadingSpinner.className = 'spinner-border spinner-border-sm ms-2';
    loadingSpinner.setAttribute('role', 'status');
    loadingSpinner.setAttribute('aria-hidden', 'true');
    
    const downloadBtn = document.getElementById('downloadPdfBtn');
    const originalBtnText = downloadBtn.innerHTML;
    downloadBtn.disabled = true;
    downloadBtn.innerHTML = 'Generating PDF...';
    downloadBtn.appendChild(loadingSpinner);
    
    // Use html2pdf library to create PDF from the roadmap content
    const element = document.getElementById('roadmapContainer');
    
    // Clone the element to modify it without affecting the displayed page
    const clonedElement = element.cloneNode(true);
    
    // Remove elements we don't want in the PDF
    const elementsToRemove = clonedElement.querySelectorAll('.no-print, button');
    elementsToRemove.forEach(el => el.remove());
    
    // Add a watermark or footer
    const footer = document.createElement('div');
    footer.style.textAlign = 'center';
    footer.style.marginTop = '20px';
    footer.style.fontSize = '10px';
    footer.style.color = '#666';
    footer.innerHTML = `Generated by KARE Learning Roadmap | ${new Date().toLocaleDateString()}`;
    clonedElement.appendChild(footer);
    
    // Generate PDF with options
    const options = {
        margin: [10, 10],
        filename: `${roadmapTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_roadmap.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    
    html2pdf().from(clonedElement).set(options).save().then(() => {
        // Restore button text when done
        downloadBtn.innerHTML = originalBtnText;
        downloadBtn.disabled = false;
        
        // Show success message
        showToast('Roadmap PDF has been generated!');
    }).catch(error => {
        console.error('Error generating PDF:', error);
        downloadBtn.innerHTML = originalBtnText;
        downloadBtn.disabled = false;
        showToast('Failed to generate PDF. Please try again.', 'danger');
    });
}